{% extends 'base.html' %}

{% block title %}BioBreak - Find a Bathroom{% endblock %}

{% block content %}
    <table id="nav-top">
        <tr>
            <td>
                {% if 'displayname' in session %}
                    <a id="logout" href="/logout">Log Out</a>&nbsp;Welcome, {{session['displayname']}}
                {% else %}
                <a id="login" href="/login">Log In or Create Account</a>
                {% endif %}
            </td>
        </tr>
    </table>
    <div id="search">
        <div id="subhead">
            Find a gender neutral, disability accessible or changing table bathroom
        </div>
        <form id="frmSearch" method="GET" action="/index_maps">
            <input id="tbSearch" type="textbox" name="txtSearch" size="50">
            <input id="btSubmit" type="button" name="btnSubmit" value="Go">
        </form>
    </div>
    <div id="noresults">
        <span id="span_noresults">&nbsp;</span>
    </div>
    <div id="map_wrapper">
        <div id="map_canvas" class="mapping"></div>
    </div>
    <script defer>
      "use strict";

            // Google Maps
          function initMap(results) {
            console.log("initMap");
            let map = new google.maps.Map(document.getElementById('map_canvas'), {
              zoom: 4,
              mapTypeId: 'roadmap',
              // user last lat/lng for center
              center: new google.maps.LatLng(results[4]["lat"], results[4]["lng"])
            });
            map.setTilt(45);

            let marker;
            let position;
            // Info Window Content
            let infoWindowContent = [];
            let infoWindow = new google.maps.InfoWindow();
            for (let i = 0; i < results.length; i++) {
                marker = new google.maps.Marker({
                    position: new google.maps.LatLng(results[i]["lat"], results[i]["lng"]),
                    map: map
                });

                infoWindowContent.push('<div class="info_content">' +
                '<h3>' + results[i]["name"] + '</h3>' +
                '<p>' + results[i]["address"] + '</br>' +
                results[i]["city"] + ', ' + results[i]["state"] +
                '</br></br><h4>Directions</h4>' + results[i]["directions"] +
                '<h4>Comments</h4>' + 'Coming Soon...' +
                '<h4>Ratings</h4>' + 'Comming Soon' + '<br/><br/>' +
                '<a href="#">View Details</a>' +
                '</p></div>');

                // Allow each marker to have an info window
                google.maps.event.addListener(marker, 'click', (function(marker, i) {
                    return function() {
                        infoWindow.setContent(infoWindowContent[i]);
                        infoWindow.open(map, marker);
                    }
                })(marker, i));

            }
          }

        function mapResults(results) {
            console.log("mapResults");
            let data = results["data"]
            if ( data.length == 0 ) {
                $('#span_noresults').text('Sorry no results were found.')
                return;
            }
          initMap(data);
        }

        function requestData() {
            console.log("requestData");
            let frmInput = $('#tbSearch').val();
            let txt = {"searchRequest": frmInput};
            $.get("/index_maps.json",txt, mapResults);
        }

        // display maps on page load
        $( document ).ready( requestData );

        // user defined search
        $('#btSubmit').click(requestData);

        // Google Places autocomplete
        let input = document.getElementById('tbSearch');
        let autocomplete = new google.maps.places.Autocomplete(input);
        google.maps.event.addListener(tbSearch, 'place_changed',
            function(){
                let place = autocomplete.getPlace();
      })

</script>

{% endblock %}
